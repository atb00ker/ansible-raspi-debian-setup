# Functions for initial setup

complete_setup() {
    install_pkgs
    ssh_setup
    connect_wifi $1
}

install_pkgs() {
    echo "Install Packages..."
    cd /home/packages/
    for pkg in */; do
        cd /home/packages/$pkg
        dpkg --install *.deb
    done
}

ssh_setup() {
    echo "Setting up ssh..."
    sed -i -r 's|^.?PermitRootLogin .*|PermitRootLogin yes|' /etc/ssh/sshd_config
    sed -i -r 's|^.?GSSAPIAuthentication .*|GSSAPIAuthentication yes|' /etc/ssh/sshd_config
    sed -i 's|session\s*required\s*pam_loginuid.so|session optional pam_loginuid.so|g' /etc/pam.d/sshd
    echo 'root:root' | chpasswd
}

connect_wifi() {
    echo "Connecting to network..."
    nmcli device wifi rescan
    sleep 5
    nmcli device wifi list
    sleep 2
    nmcli device wifi connect {{ wifi_ssid }} password $1
}

if [ -f /root/init_boot ]; then
    wifi_pass=$(cat /root/init_boot)
    complete_setup $wifi_pass &> /root/install_complete.log
    rm /root/init_boot
    shutdown -r now
fi
